<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Semantic Compression Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        header {
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 20px;
            position: sticky;
            top: 0;
        }

        #container {
            max-width: 600px;
            margin: 20px auto;
        }

        #postForm {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #postForm textarea {
            width: 100%;
            resize: none;
        }

        #postForm button {
            background: #1d9bf0;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 10px;
            cursor: pointer;
        }

        .post {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .post-header {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .post img {
            max-width: 100%;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <header>AIÂúßÁ∏ÆSNS„Éá„É¢</header>
    <div id="container">

        <!-- ÊäïÁ®ø„Éï„Ç©„Éº„É† -->
        <form id="postForm">
            <input type="file" id="imageInput" accept="image/*"><br><br>
            <textarea id="captionInput" placeholder="„ÅÑ„Åæ„Å©„ÅÜ„Åó„Å¶„ÇãÔºü" rows="2"></textarea><br>
            <button type="submit">ÊäïÁ®ø</button>
        </form>

        <!-- „Çø„Ç§„É†„É©„Ç§„É≥ -->
        <div id="timeline"></div>
    </div>

    <script>
        const form = document.getElementById('postForm');
        const timeline = document.getElementById('timeline');
        const MAX_POSTS = 10;
        const WORKER_URL = "https://semantic-worker.semantic-compression.workers.dev";

        // ü™Ñ ÁîªÂÉè„ÇíCloudflare Images„Å∏„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶URL„ÇíÂèñÂæó
        async function uploadImageAndGetUrl(imageBlob) {
            const formData = new FormData();
            formData.append("file", imageBlob, "upload.jpg");

            const response = await fetch(WORKER_URL + "/upload", {
                method: "POST",
                body: formData,
            });

            const data = await response.json();
            if (data.imageUrl) {
                console.log("‚úÖ Uploaded:", data.imageUrl);
                return data.imageUrl;
            } else {
                console.error("‚ùå Upload failed:", data);
                throw new Error("Upload failed");
            }
        }

        // üß† Cloudflare Images„ÅÆURL„Çí‰Ωø„Å£„Å¶AI„Ç≠„É£„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê
        async function generateAICaptionFromUrl(imageUrl) {
            try {
                const payload = {
                    prompt: "„Åì„ÅÆÁîªÂÉè„ÅÆÂÜÖÂÆπ„ÇíÁü≠„ÅèË™¨Êòé„Åó„Å¶",
                    image_url: { url: imageUrl },
                };

                const response = await fetch(WORKER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                const data = await response.json();
                const aiCaption = data.choices?.[0]?.message?.content || "AIÁîüÊàêÂ§±Êïó‚Ä¶";
                return aiCaption.trim();
            } catch (error) {
                console.error("AIÁîüÊàê„Ç®„É©„Éº:", error);
                return "AIÁîüÊàê„Ç®„É©„Éº";
            }
        }

        // üîÅ „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇÔºö‰øùÂ≠òÊ∏à„ÅøÊäïÁ®ø„ÇíË°®Á§∫
        window.onload = () => {
            const savedPosts = JSON.parse(localStorage.getItem("posts")) || [];
            timeline.innerHTML = "";
            savedPosts.reverse().forEach(post => addPostToTimeline(post));
        };

        // ‚úâÔ∏è ÊäïÁ®ø„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const captionInput = document.getElementById('captionInput').value;
            const file = document.getElementById('imageInput').files[0];
            if (!file) {
                alert("ÁîªÂÉè„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ");
                return;
            }

            // „Åæ„ÅöÁîªÂÉè„Çí„É™„Çµ„Ç§„Ç∫„Åó„Å¶BlobÂåñ
            resizeImage(file, 800, 800, async (compressedDataUrl, blob) => {
                try {
                    // Cloudflare Images„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶URLÂèñÂæó
                    const imageUrl = await uploadImageAndGetUrl(blob);

                    // „Ç≠„É£„Éó„Ç∑„Éß„É≥„ÅåÁ©∫Ê¨Ñ„Å™„ÇâAIÁîüÊàê
                    let finalCaption = captionInput.trim();
                    if (!finalCaption) {
                        finalCaption = await generateAICaptionFromUrl(imageUrl);
                    }

                    savePost(finalCaption, imageUrl); // ‚Üê ‰øùÂ≠òÊôÇ„ÇÇCloudflare Images„ÅÆURL„Çí‰ΩøÁî®
                    form.reset();
                } catch (err) {
                    console.error("ÊäïÁ®ø„Ç®„É©„Éº:", err);
                    alert("ÊäïÁ®ø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
                }
            });
        });

        // üíæ ÊäïÁ®ø„Çí‰øùÂ≠ò
        function savePost(caption, imageUrl) {
            let posts = JSON.parse(localStorage.getItem("posts")) || [];
            const now = new Date();
            const pseudoUser = "user_" + now.getHours() + now.getMinutes();

            const post = {
                user: pseudoUser,
                time: now.toLocaleString(),
                caption,
                image: imageUrl, // ‚Üê Base64„Åß„ÅØ„Å™„ÅèURL
            };

            posts.unshift(post);
            if (posts.length > MAX_POSTS) posts = posts.slice(0, MAX_POSTS);

            localStorage.setItem("posts", JSON.stringify(posts));
            addPostToTimeline(post);
        }

        // üß± „Çø„Ç§„É†„É©„Ç§„É≥„Å´Ë°®Á§∫
        function addPostToTimeline(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.innerHTML = `
    <div class="post-header">@${post.user} „Éª ${post.time}</div>
    <p>${post.caption}</p>
    <img src="${post.image}" alt="ÊäïÁ®øÁîªÂÉè">
  `;
            timeline.prepend(postDiv);
        }

        // üñºÔ∏è ÁîªÂÉè„ÇíCanvas„ÅßÂúßÁ∏ÆÔºãBlobÂåñ
        function resizeImage(file, maxWidth, maxHeight, callback) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }

                    const canvas = document.createElement("canvas");
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(
                        (blob) => {
                            const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
                            callback(dataUrl, blob);
                        },
                        "image/jpeg",
                        0.7
                    );
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    </script>


</body>

</html>