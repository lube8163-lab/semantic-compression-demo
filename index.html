<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Semantic Compression Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 0;
        }

        header {
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 20px;
            position: sticky;
            top: 0;
        }

        #container {
            max-width: 600px;
            margin: 20px auto;
        }

        #postForm {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #postForm textarea {
            width: 100%;
            resize: none;
        }

        #postForm button {
            background: #1d9bf0;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 10px;
            cursor: pointer;
        }

        .post {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .post-header {
            font-size: 14px;
            color: #555;
            margin-bottom: 10px;
        }

        .post img {
            max-width: 100%;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <header>AIÂúßÁ∏ÆSNS„Éá„É¢</header>
    <div id="container">

        <!-- ÊäïÁ®ø„Éï„Ç©„Éº„É† -->
        <form id="postForm">
            <input type="file" id="imageInput" accept="image/*"><br><br>
            <textarea id="captionInput" placeholder="„ÅÑ„Åæ„Å©„ÅÜ„Åó„Å¶„ÇãÔºü" rows="2"></textarea><br>
            <button type="submit">ÊäïÁ®ø</button>
        </form>

        <!-- „Çø„Ç§„É†„É©„Ç§„É≥ -->
        <div id="timeline"></div>
    </div>

    <script>
        const form = document.getElementById('postForm');
        const timeline = document.getElementById('timeline');
        const MAX_POSTS = 10;
        const WORKER_URL = "https://semantic-worker.semantic-compression.workers.dev";

        // ü™Ñ Cloudflare Images „Å∏„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
        async function uploadImageAndGetUrl(imageBlob) {
            const formData = new FormData();
            formData.append("file", imageBlob, "upload.jpg");

            const response = await fetch(WORKER_URL + "/upload", {
                method: "POST",
                body: formData,
            });

            const data = await response.json();
            if (data.imageUrl) return data.imageUrl;
            else throw new Error("Upload failed");
        }

        // üß† ÁîªÂÉèURL„Çí„ÇÇ„Å®„Å´„Ç≠„É£„Éó„Ç∑„Éß„É≥ÁîüÊàê
        async function generateAICaptionFromUrl(imageUrl) {
            const payload = {
                prompt: "„Åì„ÅÆÁîªÂÉè„ÅÆÂÜÖÂÆπ„ÇíÁü≠„ÅèË™¨Êòé„Åó„Å¶",
                image_url: { url: imageUrl },
            };
            const response = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            return data.choices?.[0]?.message?.content?.trim() || "AIÁîüÊàêÂ§±Êïó‚Ä¶";
        }

        // üé® „Ç≠„É£„Éó„Ç∑„Éß„É≥„Åã„ÇâÁîªÂÉèÂÜçÁîüÊàê
        async function regenerateImageFromCaption(caption, postDiv) {
            const payload = { caption };
            const response = await fetch(WORKER_URL + "/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            });

            const data = await response.json();
            if (data.imageUrl) {
                const img = document.createElement("img");
                img.src = data.imageUrl;
                img.alt = "ÂÜçÁîüÊàêÁîªÂÉè";
                img.style.marginTop = "10px";
                img.style.border = "1px solid #ccc";
                img.style.borderRadius = "8px";
                img.style.maxWidth = "100%";
                postDiv.appendChild(img);
            } else {
                alert("ÂÜçÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
                console.error("Regeneration failed:", data);
            }
        }

        // üîÅ ‰øùÂ≠òÊ∏à„ÅøÊäïÁ®ø„ÇíË°®Á§∫
        window.onload = () => {
            const savedPosts = JSON.parse(localStorage.getItem("posts")) || [];
            timeline.innerHTML = "";
            savedPosts.reverse().forEach(addPostToTimeline);
        };

        // ‚úâÔ∏è ÊäïÁ®øÂá¶ÁêÜ
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const captionInput = document.getElementById('captionInput').value;
            const file = document.getElementById('imageInput').files[0];
            if (!file) return alert("ÁîªÂÉè„ÇíÈÅ∏„Çì„Åß„Å≠ÔºÅ");

            resizeImage(file, 800, 800, async (compressedDataUrl, blob) => {
                try {
                    const imageUrl = await uploadImageAndGetUrl(blob);
                    let finalCaption = captionInput.trim();
                    if (!finalCaption) finalCaption = await generateAICaptionFromUrl(imageUrl);

                    savePost(finalCaption, imageUrl);
                    form.reset();
                } catch (err) {
                    console.error("ÊäïÁ®ø„Ç®„É©„Éº:", err);
                    alert("ÊäïÁ®ø‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ");
                }
            });
        });

        // üíæ ÊäïÁ®ø„Çí‰øùÂ≠ò
        function savePost(caption, imageUrl) {
            let posts = JSON.parse(localStorage.getItem("posts")) || [];
            const now = new Date();
            const pseudoUser = "user_" + now.getHours() + now.getMinutes();

            const post = {
                user: pseudoUser,
                time: now.toLocaleString(),
                caption,
                image: imageUrl,
            };

            posts.unshift(post);
            if (posts.length > MAX_POSTS) posts = posts.slice(0, MAX_POSTS);
            localStorage.setItem("posts", JSON.stringify(posts));

            addPostToTimeline(post);
        }

        // üß± „Çø„Ç§„É†„É©„Ç§„É≥ÊèèÁîª
        function addPostToTimeline(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.innerHTML = `
    <div class="post-header">@${post.user} „Éª ${post.time}</div>
    <p>${post.caption}</p>
    <img src="${post.image}" alt="ÊäïÁ®øÁîªÂÉè" style="max-width:100%; border-radius:8px;">
  `;

            // ü™Ñ ÂÜçÁîüÊàê„Éú„Çø„É≥„ÇíËøΩÂä†
            const regenBtn = document.createElement("button");
            regenBtn.textContent = "ü™Ñ ÂÜçÁîüÊàê";
            regenBtn.style.marginTop = "8px";
            regenBtn.style.background = "#888";
            regenBtn.style.color = "white";
            regenBtn.style.border = "none";
            regenBtn.style.borderRadius = "6px";
            regenBtn.style.padding = "4px 10px";
            regenBtn.style.cursor = "pointer";

            regenBtn.addEventListener("click", async () => {
                regenBtn.disabled = true;
                regenBtn.textContent = "ÁîüÊàê‰∏≠...";
                await regenerateImageFromCaption(post.caption, postDiv);
                regenBtn.textContent = "ü™Ñ ÂÜçÁîüÊàê";
                regenBtn.disabled = false;
            });

            postDiv.appendChild(regenBtn);
            timeline.prepend(postDiv);
        }

        // üñºÔ∏è ÂúßÁ∏ÆÁî®
        function resizeImage(file, maxWidth, maxHeight, callback) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }

                    const canvas = document.createElement("canvas");
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(
                        (blob) => {
                            const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
                            callback(dataUrl, blob);
                        },
                        "image/jpeg",
                        0.7
                    );
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    </script>



</body>

</html>