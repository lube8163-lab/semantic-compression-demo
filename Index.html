<script>
  const form = document.getElementById('postForm');
  const timeline = document.getElementById('timeline');
  const MAX_POSTS = 10; // 保存する最大投稿数

  // ✅ AIキャプション生成（Cloudflare Workerを利用）
  async function generateAICaption(promptText) {
    try {
      const response = await fetch("https://semantic-worker.semantic-compression.workers.dev", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: promptText })
      });

      const data = await response.json();
      const aiCaption = data.choices?.[0]?.message?.content || "AI生成失敗…";
      return aiCaption.trim();
    } catch (error) {
      console.error("AI生成エラー:", error);
      return "AI生成エラー";
    }
  }

  // ページ読み込み時に保存済み投稿を新しい順で表示
  window.onload = () => {
    const savedPosts = JSON.parse(localStorage.getItem("posts")) || [];
    timeline.innerHTML = "";
    savedPosts.reverse().forEach(post => addPostToTimeline(post));
  };

  // 投稿フォーム処理
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const caption = document.getElementById('captionInput').value;
    const file = document.getElementById('imageInput').files[0];

    if (!file) {
      alert("画像を選んでね！");
      return;
    }

    // 画像を圧縮して保存
    resizeImage(file, 800, 800, async (compressedDataUrl) => {
      let finalCaption = caption.trim();

      // ✅ キャプションが空ならAIに生成依頼
      if (!finalCaption) {
        finalCaption = await generateAICaption("この画像の内容を短く説明して");
      }

      savePost(finalCaption, compressedDataUrl);
      form.reset();
    });
  });

  // 投稿を保存
  function savePost(caption, imageData) {
    let posts = JSON.parse(localStorage.getItem("posts")) || [];
    const now = new Date();
    const pseudoUser = "user_" + now.getHours() + now.getMinutes();
    const post = {
      user: pseudoUser,
      time: now.toLocaleString(),
      caption: caption,
      image: imageData
    };

    posts.unshift(post);

    if (posts.length > MAX_POSTS) {
      posts = posts.slice(0, MAX_POSTS);
    }

    localStorage.setItem("posts", JSON.stringify(posts));
    addPostToTimeline(post);
  }

  // タイムラインに表示
  function addPostToTimeline(post) {
    const postDiv = document.createElement('div');
    postDiv.className = 'post';
    postDiv.innerHTML = `
      <div class="post-header">@${post.user} ・ ${post.time}</div>
      <p>${post.caption}</p>
      <img src="${post.image}" alt="投稿画像">
    `;
    timeline.prepend(postDiv);
  }

  // 画像リサイズ・圧縮
  function resizeImage(file, maxWidth, maxHeight, callback) {
    const reader = new FileReader();
    reader.onload = function(event) {
      const img = new Image();
      img.onload = function() {
        let width = img.width;
        let height = img.height;

        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
        if (height > maxHeight) {
          width *= maxHeight / height;
          height = maxHeight;
        }

        const canvas = document.createElement("canvas");
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, width, height);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
        callback(dataUrl);
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }
</script>
